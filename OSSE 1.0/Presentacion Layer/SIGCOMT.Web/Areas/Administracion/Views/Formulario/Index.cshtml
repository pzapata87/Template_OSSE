@using Resources
@using SIGCOMT.Common.Constantes
@using SIGCOMT.DTO
@model List<ModuloDto>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutCRM.cshtml";
}

@section StyleContent
{
    <link href="@Url.Content("~/Content/css/select2.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/css/style.datatables.css")" rel="stylesheet" type="text/css" />
    <link href="//cdn.datatables.net/responsive/1.0.2/css/dataTables.responsive.css" rel="stylesheet">
}

@section pageheader
{
    <div class="pageicon pull-left">
        <i class="fa fa-home"></i>
    </div>
    <div class="media-body">
        <h4>Formulario</h4>
    </div>
}

<div class="panel panel-primary">
    <div class="panel-heading">
        <h4 class="panel-title">Formulario de Permisos</h4>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-sm-6">
                @*<label class="control-label">Formularios</label>
                <div class="mb5"></div>
                <select id="selFormulario" data-placeholder="@Master.Seleccionar" class="width300">
                    @if (Model != null)
                    {
                        foreach (var modulo in Model)
                        {
                            <optgroup label="@modulo.Nombre">
                                @foreach (var operacion in modulo.Operaciones)
                                {
                                    <option value="@operacion.Id">@operacion.Nombre</option>
                                }
                            </optgroup>
                        }
                    }

                </select>*@
                <table id="grillaPermisos" class="table table-bordered table-hover table-responsive">
                    <thead>
                        <tr>
                            <th></th>
                            <th style="width: 20%;">Módulo</th>
                            <th style="width: 80%;">Formulario</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null)
                        {
                            foreach (var modulo in Model)
                            {
                                foreach (var operacion in modulo.Operaciones)
                                {
                                    <tr>
                                        <td class="details-control"></td>
                                        <td>@modulo.Nombre</td>
                                        <td>@operacion.Nombre</td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
                <div class="mb30"></div>
                <div id="divPermisos"></div>
            </div>
            <div class="col-sm-6">
                <table id="grillaUsuario" class="table table-bordered table-hover table-responsive">
                    <thead class="">
                        <tr>
                            <th style="width: 5%;"></th>
                            <th style="width: 95%;">User Name</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <div class="panel-footer">
        <div class="col-sm-offset-2">
            <button class="btn btn-primary mr5">Guardar</button>
            <a href="@Url.Action("Index", "Usuario", new { area = "Administracion"})" class="btn btn-default">Regresar</a>
        </div>
    </div>
</div>

@section ScriptContent
{
    <script src="@Url.Content("~/Content/js/jquery.dataTables.min.js")"></script>
    <script src="@Url.Content("~/Content/js/dataTables.bootstrap.js")"></script>
    <script src="//cdn.datatables.net/responsive/1.0.2/js/dataTables.responsive.js"></script>
    <script src="//cdn.datatables.net/plug-ins/725b2a2115b/api/fnFilterOnReturn.js"></script>
    <script src="@Url.Content("~/Content/js/select2.min.js")"></script>

    <script type="text/javascript">

        jQuery(document).ready(function() {
            //jQuery("#selFormulario")
            //    .select2()
            //    .on("change", function() {
            //        ObtenerPermiso(jQuery(this).val());
            //    });

            var grillaPermisos = jQuery('#grillaPermisos').DataTable({
                responsive: true,
                language: {
                    "url": "@Url.Content(string.Format("~/Content/js/languages/dataTables.{0}.json", ViewData[MasterConstantes.Idioma]))"
                },
                //columns: [
                //    {
                //        orderable: false,
                //        defaultContent: ''
                //    }
                //]
            });

            var opciones = {
                grilla: '#grillaUsuario',
                textAll: '@Master.Todos',
                languageUrl: "@Url.Content(string.Format("~/Content/js/languages/dataTables.{0}.json", ViewData[MasterConstantes.Idioma]))",
                url: '@Url.Action("Listar", "Usuario", new {area = "Administracion"})',
                columns: [
                    {
                        "data": function(oObj) {
                            var btnSeleccionar = '<a href="" data-toggle="tooltip" title="Edit" class="tooltips"><i class="fa fa-check-square-o"></i></a>';
                            return btnSeleccionar;
                        },
                        "orderable": false,
                        "searchable": false
                    },
                    { "data": "UserName", "name": "UserName" }
                ]
            };

            Utils.Grilla(opciones);

            // Add event listener for opening and closing details
            jQuery('#grillaPermisos tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = grillaPermisos.row(tr);
                debugger;
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    // Open this row
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
        });

        function ObtenerPermiso(id) {
            var $divCheck = jQuery('#divPermisos');
            $divCheck.empty();

            if (id != '') {
                var opcionesAjax = {
                    url: '@Url.Action("ObtenerPermiso", "Formulario", new {area = "Administracion"})',
                    parametros: {
                        formularioId: id
                    }
                };

                Utils.Ajax(opcionesAjax, function(response) {
                    if (response.Success == true) {
                        for (var i = 0; i < response.Data.length; i++) {
                            var data = response.Data[i];
                            var check = '<div class="ckbox ckbox-success">'
                                + '<input type="checkbox" id="' + data.TipoPermiso + '" checked="checked" />'
                                + '<label for="' + data.TipoPermiso + '">' + data.NombrePermiso + '</label>'
                                + '</div>';
                            $divCheck.append(check);
                        }
                    }
                });
            }
        }

        function format(d) {
            var check = '';
            for (var i = 1; i <= 10; i++) {
                check += '<div class="ckbox ckbox-success col-sm-4">'
                + '<input type="checkbox" id="' + i + '" checked="checked" />'
                + '<label for="' + i + '">' + 'Crear' + '</label>'
                + '</div>';
            }
            return check;
        }

    </script>
}