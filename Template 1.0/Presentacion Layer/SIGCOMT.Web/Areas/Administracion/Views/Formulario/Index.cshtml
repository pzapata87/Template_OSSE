@using SIGCOMT.Common.Constantes
@using SIGCOMT.DTO
@using SIGCOMT.Resources
@model List<FormularioDto>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutCRM.cshtml";
}

@section StyleContent
{
    <link href="@Url.Content("~/Content/css/select2.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/css/style.datatables.css")" rel="stylesheet" type="text/css" />
    <link href="//cdn.datatables.net/responsive/1.0.3/css/dataTables.responsive.css" rel="stylesheet">
}

@section pageheader
{
    <div class="media-body">
        <h3><i class="fa fa-home mr5"></i>@Formulario.TituloListado</h3>
    </div>
}

<div class="panel panel-primary">
    <div class="panel-heading">
        <h4 class="panel-title">@Formulario.TituloPanelEdicion</h4>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-sm-6">
                <table id="grillaPermisos" class="table table-bordered table-responsive">
                    <thead>
                        <tr>
                            <th style="width: 5%;"></th>
                            <th style="width: 20%;">@Formulario.Modulo</th>
                            <th style="width: 75%;">@Formulario.Formulario_Display</th>
                        </tr>
                    </thead>
                </table>
                <div class="mb30"></div>
                <div id="divPermisos"></div>
            </div>
            <div class="col-sm-6">
                <table id="grillaUsuario" class="table table-bordered table-responsive">
                    <thead class="">
                        <tr>
                            <th style="width: 6%;"></th>
                            <th style="width: 94%;">@Formulario.Usuario</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <div class="panel-footer">
        <div class="col-sm-offset-2">
            <button class="btn btn-primary mr5">@Master.Guardar</button>
            <a href="@Url.Action("Index", "Usuario", new { area = "Administracion"})" class="btn btn-default">@Master.Regresar</a>
        </div>
    </div>
</div>

@section ScriptContent
{
    <script src="@Url.Content("~/Content/js/jquery.dataTables.min.js")"></script>
    <script src="@Url.Content("~/Content/js/dataTables.bootstrap.js")"></script>
    <script src="//cdn.datatables.net/responsive/1.0.3/js/dataTables.responsive.js"></script>
    <script src="@Url.Content("~/Content/js/fnFilterOnReturn.js")"></script>

    <script type="text/javascript">

        var checksSelected = [];

        jQuery(document).ready(function() {

            var dataSet = JSON.parse('@Html.Raw(Json.Encode(Model))');

            var grillaPermisos = jQuery('#grillaPermisos').DataTable({
                dom: '<"left"f><"right"l>trip',
                responsive: true,
                language: {
                    "url": "@Url.Content(string.Format("~/Content/js/languages/dataTables.{0}.json", ViewData[MasterConstantes.Idioma]))"
                },
                data: dataSet,
                columns: [
                    {
                        "class": 'details-control',
                        "orderable": false,
                        "data": null,
                        "defaultContent": '',
                        "searchable": false
                    },
                    { "data": "Modulo" },
                    { "data": "Nombre" }
                ],
                "order": [[1, 'asc']]
            });

            jQuery('#grillaPermisos tbody').on('click', 'td.details-control', function() {
                var tr = $(this).closest('tr');
                var row = grillaPermisos.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });

            var opciones = {
                grilla: '#grillaUsuario',
                textAll: '@Master.Todos',
                languageUrl: "@Url.Content(string.Format("~/Content/js/languages/dataTables.{0}.json", ViewData[MasterConstantes.Idioma]))",
                url: '@Url.Action("Listar", "Usuario", new {area = "Administracion"})',
                selectable: true,
                useCheckIcon: true,
                onSelectRow: seleccionarUsuario,
                columns: [
                    {
                        "data": function(oObj) {
                            return '<span title="Seleccionar" style="color: #428bca;"><i class="fa fa-square-o"></i></span>';
                        },
                        "orderable": false,
                        "searchable": false
                    },
                    { "data": "UserName", "name": "UserName" }
                ]
            };

            Utils.Grilla(opciones);

            jQuery('#grillaPermisos tbody').on('click', 'input[type=checkbox]', function () {
                var $check = $(this);
                var formId = $check.data('form');
                var tipoPermiso = $check.data('permiso');

                if ($check.prop("checked")) {
                    checksSelected.push({ FormularioId: formId, TipoPermiso: tipoPermiso });
                } else {
                    for (var i = 0; i < checksSelected.length; i++) {
                        var item = checksSelected[i];
                        if (item.FormularioId == formId && item.TipoPermiso == tipoPermiso) {
                            checksSelected.splice(i, 1);
                            break;
                        }
                    }
                }
            });
        });

        function format(rowData) {
            var check = '', permiso, id, index = -1, checked = '';
            for (var i = 0; i < rowData.PermisoList.length; i++) {
                permiso = rowData.PermisoList[i];

                for (var j = 0; j < checksSelected.length; j++) {
                    index = -1;
                    var item = checksSelected[j];
                    if (item.FormularioId == permiso.FormularioId && item.TipoPermiso == permiso.TipoPermiso) {
                        index = i;
                        break;
                    }
                }

                if (index != -1)
                    checked = 'checked="checked"';
                else
                    checked = '';

                id = ''.concat(permiso.FormularioId, permiso.TipoPermiso);
                check += '<div class="ckbox ckbox-success col-sm-4">'
                    + '<input type="checkbox" id="' + id + '" ' + checked + ' data-form="' + permiso.FormularioId + '" data-permiso="' + permiso.TipoPermiso + '"/>'
                    + '<label for="' + id + '">' + permiso.NombrePermiso + '</label>'
                    + '</div>';

            }
            return check;
        }

        function seleccionarUsuario(row, grilla) {
            var rowData = grilla.row(row).data();

            var opcionesAjax = {
                url: '@Url.Action("ObtenerPermisoFormulario", "Usuario", new {area = "Administracion"})',
                parametros: {
                    usuarioId: rowData.Id
                }
            };

            Utils.Ajax(opcionesAjax, function(response) {
                if (response.Success == true) {
                    var permiso, id;
                    checksSelected = response.Data;
                    for (var i = 0; i < response.Data.length; i++) {
                        permiso = response.Data[i];
                        id = ''.concat(permiso.FormularioId, permiso.TipoPermiso);
                        jQuery('#grillaPermisos input[id=' + id + ']').prop('checked', true);
                    }
                }
            });
        }

    </script>
}